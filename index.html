<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸ªäººåŒ–å¥åº·è†³é£ŸåŠ©æ‰‹ â€” å•æ–‡ä»¶ç‰ˆ</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Firebase (v8 å…¼å®¹ CDN, é€‚ç”¨äº file:/// æœ¬åœ°æ‰“å¼€) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  :root{
    --bg1:#6a11cb; --bg2:#2575fc;
    --card-bg: rgba(255,255,255,0.06);
    --glass: rgba(255,255,255,0.06);
    --accent:#efeefe;
    --muted: rgba(255,255,255,0.8);
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family: "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color: #fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Layout */
  .wrap{ max-width:1200px; margin:28px auto; padding:20px; display:grid; gap:20px;
         grid-template-columns: 420px 1fr; }
  @media (max-width:980px){ .wrap{ grid-template-columns: 1fr; padding:12px } }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:var(--radius);
    padding:18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border:1px solid rgba(255,255,255,0.04);
    transition: transform .18s ease;
  }
  .card:hover{ transform: translateY(-6px); }

  h1,h2{ margin:0 0 12px 0; color:var(--accent) }
  label{ display:block; font-size:0.9rem; color:var(--muted); margin-bottom:6px }
  input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--accent); margin-bottom:10px; }
  .row{ display:flex; gap:10px }
  .row .col{ flex:1 }

  button{
    padding:10px 14px; border-radius:12px; border:none; cursor:pointer;
    color:white; font-weight:600;
    background: linear-gradient(90deg,#a78bfa,#7c3aed);
    box-shadow: 0 8px 24px rgba(124,58,237,0.28);
  }
  button.ghost{ background: rgba(255,255,255,0.05); box-shadow:none; color:var(--muted) }

  .small{ font-size:0.9rem; color:var(--muted) }
  .avatar{ width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02)); display:flex;align-items:center;justify-content:center;font-size:1.4rem;margin-right:12px; }

  /* meals grid */
  .meals{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px }
  @media (max-width:900px){ .meals{ grid-template-columns: 1fr } }
  .meal-item{ padding:14px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03) }

  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ padding:8px; text-align:left; border-bottom:1px dashed rgba(255,255,255,0.04); font-size:0.95rem; color:var(--muted) }

  .bad-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px }
  @media (max-width:900px){ .bad-grid{ grid-template-columns:1fr } }

  footer{ color: rgba(255,255,255,0.7); font-size:0.85rem; text-align:center; margin-top:10px }
  .hint{ font-size:0.85rem; color:rgba(255,255,255,0.7); margin-top:8px }

  /* animations */
  .fade-in{ animation:fadeIn .6s ease both }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

  /* responsive small UI tweaks */
  .stat-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px }
  @media (max-width:900px){ .stat-grid{ grid-template-columns:1fr } }
</style>
</head>
<body>
  <div class="wrap">
    <!-- left column: form & summary -->
    <div class="card fade-in">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center">
          <div class="avatar">ğŸ©º</div>
          <div>
            <div style="font-weight:700; font-size:1rem">ä¸ªäººåŒ–å¥åº·è†³é£ŸåŠ©æ‰‹</div>
            <div class="small">è¾“å…¥ä¿¡æ¯ï¼Œä¿å­˜è‡³ Firebase å¹¶ç”Ÿæˆå»ºè®®</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="small">ç”¨æˆ·æ•°</div>
          <div style="font-weight:700; font-size:1.25rem" id="userCount">0</div>
        </div>
      </div>

      <hr style="border:none;height:12px">

      <h2>ç”¨æˆ·ç™»å½• / æ³¨å†Œ</h2>
      <label for="name">å§“å</label>
      <input id="name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">

      <div class="row">
        <div class="col">
          <label for="height">èº«é«˜ (cm)</label>
          <input id="height" type="number" min="50" max="250" step="0.1" placeholder="170">
        </div>
        <div class="col">
          <label for="weight">ä½“é‡ (kg)</label>
          <input id="weight" type="number" min="20" max="300" step="0.1" placeholder="65">
        </div>
      </div>

      <label for="age">å¹´é¾„</label>
      <input id="age" type="number" min="5" max="120" placeholder="30">

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="saveBtn">ä¿å­˜å¹¶ç”Ÿæˆå»ºè®® âœ¨</button>
        <button id="clearBtn" class="ghost">æ¸…ç©º</button>
      </div>

      <div class="hint">ä¿å­˜åä¼šå†™å…¥ Firebase å®æ—¶æ•°æ®åº“ (/users)ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ä¸æ•°æ®åº“è§„åˆ™ä»¥ç¡®è®¤å†™å…¥æƒé™ã€‚</div>
    </div>

    <!-- right column: results, meals, charts -->
    <div style="display:grid; gap:20px;">
      <div class="card fade-in" id="resultCard">
        <h2 id="greeting">ä¸ªæ€§åŒ–å¥åº·å»ºè®®</h2>
        <div id="bmiInfo" class="small">è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯å¹¶ä¿å­˜ä»¥æŸ¥çœ‹è¯¦ç»†å»ºè®®</div>

        <div style="height:12px"></div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1; min-width:220px">
            <div style="font-weight:700">ä»Šæ—¥ä¸‰é¤å»ºè®®</div>
            <div class="meals" id="mealsContainer">
              <!-- æ—©é¤/åˆé¤/æ™šé¤ å¡ç‰‡æ³¨å…¥ -->
            </div>
          </div>

          <div style="width:360px; min-width:260px">
            <div style="font-weight:700">é£Ÿå“çƒ­é‡ & è¥å…»</div>
            <div id="foodTableWrapper"></div>
          </div>
        </div>
      </div>

      <div class="card fade-in">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>ä¸å¥åº·é£Ÿå“ & è¿åŠ¨å»ºè®®</h2>
          <div class="chip" style="background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:999px;font-size:0.9rem;color:var(--muted)">é«˜çƒ­é‡å¯¹ç…§</div>
        </div>

        <div class="bad-grid" id="badList" style="margin-top:12px"></div>

        <div style="height:12px"></div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <div style="flex:1; min-width:240px">
            <h3 style="margin:0 0 8px 0">è¿åŠ¨æ¶ˆè€—ä¼°ç®—</h3>
            <table>
              <thead><tr><th>è¿åŠ¨</th><th>ä¼°è®¡ kcal/å°æ—¶</th></tr></thead>
              <tbody>
                <tr><td>å¿«èµ° (5 km/h)</td><td>240 - 320</td></tr>
                <tr><td>æ…¢è·‘ (8 km/h)</td><td>550 - 700</td></tr>
                <tr><td>éª‘è¡Œ (16â€“20 km/h)</td><td>400 - 600</td></tr>
                <tr><td>HIITï¼ˆé«˜å¼ºåº¦ï¼‰</td><td>600 - 900</td></tr>
              </tbody>
            </table>

            <div style="margin-top:8px;">
              <label for="calInput">æƒ³æ¶ˆè€—çš„çƒ­é‡ (kcal)</label>
              <input id="calInput" type="number" placeholder="ä¾‹å¦‚ 500">
              <div style="display:flex;gap:8px;">
                <button id="calcTimeBtn">è®¡ç®—è¿åŠ¨æ—¶é—´</button>
                <button id="copyBtn" class="ghost">å¤åˆ¶ç»“æœ</button>
              </div>
              <pre id="timeResult" class="small" style="white-space:pre-wrap;margin-top:8px"></pre>
            </div>
          </div>

          <div style="flex:1; min-width:240px">
            <h3 style="margin:0 0 8px 0">æŒ‰å¹´é¾„æ®µç”¨æˆ·å æ¯”</h3>
            <canvas id="ageChart" height="220" style="background:#fff;border-radius:12px;padding:8px"></canvas>
            <div class="hint">â€œæ­£å¸¸ / è¶…é‡â€å æ¯”ï¼ˆå®æ—¶è¯»å–æ•°æ®åº“ /usersï¼‰ã€‚</div>
          </div>
        </div>
      </div>

      <div class="card fade-in">
        <h2>ç”¨æˆ·æ•°æ®ï¼ˆæœ€è¿‘ 50 æ¡ï¼‰</h2>
        <div id="tableWrap" style="max-height:280px; overflow:auto;"></div>
        <footer>å•æ–‡ä»¶è®¾è®¡ Â· ç´«è‰²æ¸å˜ Â· å¡ç‰‡å¼å¸ƒå±€</footer>
      </div>
    </div>
  </div>

<script>
/* ================= Firebase é…ç½® =================
   æˆ‘å·²æŠŠä½ æœ€æ–°æä¾›çš„é…ç½®æ”¾å…¥æ­¤å¤„ï¼ˆå¦‚éœ€æ›¿æ¢è¯·æ”¹ä¸‹é¢å¯¹è±¡ï¼‰
*/
const firebaseConfig = {
  apiKey: "AIzaSyABck4GsHq7x68LUQQ0tqPg9Lj6XoYXi1g",
  authDomain: "project-2607536693074291471.firebaseapp.com",
  databaseURL: "https://project-2607536693074291471-default-rtdb.firebaseio.com",
  projectId: "project-2607536693074291471",
  storageBucket: "project-2607536693074291471.firebasestorage.app",
  messagingSenderId: "841252265184",
  appId: "1:841252265184:web:b5a7db1dd06acbb55ec485",
  measurementId: "G-NPGBYV26TJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= DOM å…ƒç´  ================= */
const nameInput = document.getElementById('name');
const heightInput = document.getElementById('height');
const weightInput = document.getElementById('weight');
const ageInput = document.getElementById('age');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');

const greeting = document.getElementById('greeting');
const bmiInfo = document.getElementById('bmiInfo');
const mealsContainer = document.getElementById('mealsContainer');
const foodTableWrapper = document.getElementById('foodTableWrapper');
const badList = document.getElementById('badList');
const userCountEl = document.getElementById('userCount');
const tableWrap = document.getElementById('tableWrap');

const calInput = document.getElementById('calInput');
const calcTimeBtn = document.getElementById('calcTimeBtn');
const timeResult = document.getElementById('timeResult');
const copyBtn = document.getElementById('copyBtn');

const ageCtx = document.getElementById('ageChart').getContext('2d');

/* ================= ä¸å¥åº·é£Ÿå“æ•°æ® ================= */
const unhealthyFoods = [
  { name: 'ç‚¸é¸¡ï¼ˆ1ä»½ï¼‰', kcal: 800, note: 'é«˜æ²¹é«˜ç›' },
  { name: 'è–¯æ¡ï¼ˆä¸­ï¼‰', kcal: 450, note: 'é«˜è„‚è‚ª' },
  { name: 'æŠ«è¨ï¼ˆ2ç‰‡ï¼‰', kcal: 650, note: 'åŠ å·¥é«˜çƒ­é‡' },
  { name: 'æ±‰å ¡ï¼ˆå«é…±ï¼‰', kcal: 550, note: 'é«˜è„‚é«˜ç›' },
  { name: 'å¥¶æ²¹è›‹ç³•ï¼ˆ1å—ï¼‰', kcal: 520, note: 'é«˜ç³–é«˜è„‚' },
  { name: 'ç³–æœï¼ˆ30gï¼‰', kcal: 120, note: 'ç©ºå¡è·¯é‡Œ' },
  { name: 'å•¤é…’ï¼ˆ500mlï¼‰', kcal: 210, note: 'æ¶²ä½“çƒ­é‡' },
  { name: 'ç‚¸æ˜¥å·ï¼ˆ1ä»½ï¼‰', kcal: 330, note: 'æ²¹ç‚¸ç±»' },
];

/* æ¸²æŸ“ä¸å¥åº·é£Ÿå“ */
function renderBadList(){
  badList.innerHTML = '';
  unhealthyFoods.forEach(f=>{
    const el = document.createElement('div');
    el.className = 'meal-item';
    el.innerHTML = `<div style="font-weight:700">${f.name} <span style="float:right">${f.kcal} kcal</span></div>
                    <div class="small">${f.note}</div>`;
    badList.appendChild(el);
  });
}
renderBadList();

/* ================= BMI è®¡ç®—ä¸åˆ†ç±» ================= */
function calcBMI(weightKg, heightCm){
  const h = heightCm/100;
  const bmiVal = weightKg / (h*h);
  let category = '';
  if (bmiVal < 18.5) category = 'åç˜¦';
  else if (bmiVal < 25) category = 'æ­£å¸¸';
  else if (bmiVal < 30) category = 'è¶…é‡';
  else category = 'è‚¥èƒ–';
  return { bmi: Number(bmiVal.toFixed(1)), category };
}

/* ================= é£Ÿè°±ç”Ÿæˆå™¨ï¼ˆç¤ºä¾‹è§„åˆ™ï¼Œå¯æ‰©å±•ï¼‰ ================= */
function generateMeals(bmi, age){
  // åŸºç¡€æ¯æ—¥çƒ­é‡ç²—ä¼°ï¼ˆç¤ºä¾‹ï¼‰
  let baseCal = 2000;
  if (age < 18) baseCal = 2200;
  else if (age <= 30) baseCal = 2300;
  else if (age <= 50) baseCal = 2000;
  else baseCal = 1800;

  let factor = 1.0;
  if (bmi < 18.5) factor = 1.12;
  else if (bmi < 25) factor = 1.0;
  else if (bmi < 30) factor = 0.85;
  else factor = 0.75;

  const dailyCal = Math.round(baseCal * factor);
  const breakfastCal = Math.round(dailyCal * 0.25);
  const lunchCal = Math.round(dailyCal * 0.40);
  const dinnerCal = Math.round(dailyCal * 0.35);

  function mealItems(mealCal, mealType){
    const list = [];
    if (mealType === 'breakfast'){
      if (bmi < 18.5){
        list.push({name:'ç‡•éº¦ç‰›å¥¶ç²¥ + åšæœ', kcal: Math.round(mealCal*0.45), note:'é«˜çº¤ç»´ä¸å¥åº·è„‚è‚ª'});
        list.push({name:'ç…è›‹ + å…¨éº¦é¢åŒ…', kcal: Math.round(mealCal*0.35), note:'ä¼˜è´¨è›‹ç™½'});
        list.push({name:'å°æ¯æœæ±', kcal: Math.round(mealCal*0.20), note:'ç»´ç”Ÿç´ '});
      } else if (bmi < 25){
        list.push({name:'å¸Œè…Šé…¸å¥¶ + è“è“ + ç‡•éº¦', kcal: Math.round(mealCal*0.5), note:'é«˜è›‹ç™½ã€é€‚é‡ç¢³æ°´'});
        list.push({name:'æ°´ç…®è›‹', kcal: Math.round(mealCal*0.15), note:'ä¼˜è´¨è›‹ç™½'});
        list.push({name:'å…¨éº¦åå¸', kcal: Math.round(mealCal*0.35), note:'ç¼“é‡Šç¢³æ°´'});
      } else {
        list.push({name:'è”¬æœæ²™æ‹‰ + ç…®é¸¡è›‹', kcal: Math.round(mealCal*0.55), note:'ä½è„‚é«˜çº¤ç»´'});
        list.push({name:'å°ä»½ç‡•éº¦', kcal: Math.round(mealCal*0.45), note:'æ§åˆ¶è¡€ç³–'});
      }
    } else if (mealType === 'lunch'){
      if (bmi < 18.5){
        list.push({name:'çº¢çƒ§ç‰›è‚‰ + ç±³é¥­(ä¸­)', kcal: Math.round(mealCal*0.55), note:'é«˜çƒ­é‡ä¼˜è´¨è›‹ç™½'});
        list.push({name:'è’¸è”¬èœ', kcal: Math.round(mealCal*0.15), note:'ç»´ç”Ÿç´ çº¤ç»´'});
        list.push({name:'è±†è…æ±¤', kcal: Math.round(mealCal*0.30), note:'æ¤ç‰©è›‹ç™½'});
      } else if (bmi < 25){
        list.push({name:'ä¸‰æ–‡é±¼ + è—œéº¦/ç³™ç±³', kcal: Math.round(mealCal*0.55), note:'ä¼˜è´¨è„‚è‚ªä¸è›‹ç™½'});
        list.push({name:'æ©„æ¦„æ²¹è‰²æ‹‰(å°‘é‡)', kcal: Math.round(mealCal*0.20), note:'å¥åº·è„‚è‚ª'});
        list.push({name:'è’¸è”¬èœ', kcal: Math.round(mealCal*0.25), note:'å¾®é‡å…ƒç´ '});
      } else {
        list.push({name:'æ¸…è’¸é¸¡èƒ¸ + å¤§é‡è”¬èœ', kcal: Math.round(mealCal*0.5), note:'ä½è„‚é«˜è›‹ç™½'});
        list.push({name:'å°‘é‡ç³™ç±³', kcal: Math.round(mealCal*0.3), note:'é€‚é‡ç¢³æ°´'});
        list.push({name:'æ¸…æ±¤', kcal: Math.round(mealCal*0.2), note:'é¥±è…¹æ„Ÿ'});
      }
    } else { // dinner
      if (bmi < 18.5){
        list.push({name:'å¥¶é…ªæ„é¢(å°)', kcal: Math.round(mealCal*0.55), note:'ç¢³æ°´+è„‚è‚ªå¸®åŠ©å¢é‡'});
        list.push({name:'ç…é±¼/é¸¡è…¿', kcal: Math.round(mealCal*0.35), note:'ä¼˜è´¨è›‹ç™½'});
        list.push({name:'æ¸…ç‚’è”¬èœ', kcal: Math.round(mealCal*0.10), note:'çº¤ç»´'});
      } else if (bmi < 25){
        list.push({name:'é±¼ç±»æˆ–è±†è… + å¤§é‡è”¬èœ', kcal: Math.round(mealCal*0.55), note:'æ™šé¤æ¸…æ·¡ï¼Œè›‹ç™½ä¼˜å…ˆ'});
        list.push({name:'å°ä»½æ‚ç²®é¥­', kcal: Math.round(mealCal*0.30), note:'ç¼“é‡Šç¢³æ°´'});
        list.push({name:'æ°´æœ(å°ä»½)', kcal: Math.round(mealCal*0.15), note:'ç»´ç”Ÿç´ '});
      } else {
        list.push({name:'æ¸…è’¸é±¼/è±†è… + å¤§é‡è”¬èœ', kcal: Math.round(mealCal*0.6), note:'ä½çƒ­é‡é«˜è›‹ç™½'});
        list.push({name:'å°‘é‡ä¸»é£Ÿ', kcal: Math.round(mealCal*0.25), note:'æ™šé—´ç¢³æ°´æ§åˆ¶'});
        list.push({name:'æ¸©æ±¤', kcal: Math.round(mealCal*0.15), note:'åŠ©çœ '});
      }
    }
    return list;
  }

  return {
    dailyCal, breakfast: mealItems(breakfastCal,'breakfast'),
    lunch: mealItems(lunchCal,'lunch'), dinner: mealItems(dinnerCal,'dinner')
  };
}

/* æ¸²æŸ“é¤å•ä¸é£Ÿç‰©è¡¨æ ¼ */
function renderMealsAndTable(meals){
  mealsContainer.innerHTML = '';
  const mealNames = ['æ—©é¤','åˆé¤','æ™šé¤'];
  const lists = [meals.breakfast, meals.lunch, meals.dinner];
  lists.forEach((arr,i)=>{
    const card = document.createElement('div');
    card.className = 'meal-item';
    const total = arr.reduce((s,a)=>s+a.kcal,0);
    card.innerHTML = `<div style="font-weight:700">${mealNames[i]} â€” çº¦ ${total} kcal</div>`;
    arr.forEach(d=>{
      const row = document.createElement('div');
      row.style.marginTop = '8px';
      row.innerHTML = `<div style="font-weight:600">${d.name} <span style="float:right">${d.kcal} kcal</span></div>
                       <div class="small">${d.note}</div>`;
      card.appendChild(row);
    });
    mealsContainer.appendChild(card);
  });

  // é£Ÿç‰©è¡¨æ ¼
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>é£Ÿç‰©</th><th>çƒ­é‡</th><th>è¥å…»è¦ç‚¹</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  [...meals.breakfast,...meals.lunch,...meals.dinner].forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:600">${d.name}</td><td>${d.kcal} kcal</td><td class="small">${d.note}</td>`;
    tbody.appendChild(tr);
  });
  foodTableWrapper.innerHTML = '';
  foodTableWrapper.appendChild(table);
}

/* ================= è¿åŠ¨æ—¶é—´ä¼°ç®— ================= */
const activities = [
  { name:'å¿«èµ°ï¼ˆ5 km/hï¼‰', min:240, max:320 },
  { name:'æ…¢è·‘ï¼ˆ8 km/hï¼‰', min:550, max:700 },
  { name:'éª‘è¡Œï¼ˆ16â€“20 km/hï¼‰', min:400, max:600 },
  { name:'HIITï¼ˆé«˜å¼ºåº¦ï¼‰', min:600, max:900 },
  { name:'æ¸¸æ³³ï¼ˆä¸­ç­‰ï¼‰', min:400, max:600 }
];
calcTimeBtn.addEventListener('click', ()=>{
  const K = Number(calInput.value);
  if (!K || K <= 0){ timeResult.textContent = 'è¯·è¾“å…¥æ­£æ•°çš„çƒ­é‡å€¼ï¼ˆkcalï¼‰ã€‚'; return; }
  let out = `æ¶ˆè€— ${K} kcal ä¼°ç®—ï¼š\n`;
  activities.forEach(a=>{
    const minH = (K / a.max) * 60; // minutes
    const maxH = (K / a.min) * 60;
    out += `${a.name}ï¼šçº¦ ${Math.round(minH)} - ${Math.round(maxH)} åˆ†é’Ÿ\n`;
  });
  timeResult.textContent = out;
});
copyBtn.addEventListener('click', ()=>{
  const txt = timeResult.textContent;
  if (!txt) return alert('å…ˆè®¡ç®—å†å¤åˆ¶');
  navigator.clipboard?.writeText(txt).then(()=>alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(()=>alert('å¤åˆ¶å¤±è´¥'));
});

/* ================= å¹´é¾„æ®µç»Ÿè®¡å›¾ï¼ˆChart.jsï¼‰ ================= */
const ageGroups = ['<18','18-30','31-45','46-60','60+'];
let ageChart = new Chart(ageCtx, {
  type:'bar',
  data:{
    labels: ageGroups,
    datasets:[
      { label:'æ­£å¸¸/åç˜¦ %', data:[0,0,0,0,0], backgroundColor:'#8adf8a' },
      { label:'è¶…é‡/è‚¥èƒ– %', data:[0,0,0,0,0], backgroundColor:'#ff7b7b' }
    ]
  },
  options:{
    responsive:true,
    plugins:{ legend:{ position:'bottom', labels:{color:'#000'} } },
    scales:{
      x:{ ticks:{ color:'#000' } },
      y:{ ticks:{ color:'#000' }, beginAtZero:true, max:100 }
    }
  }
});

/* ================= å®æ—¶æ•°æ®åº“ç›‘å¬ä¸è¡¨æ ¼æ¸²æŸ“ ================= */
function attachRealtimeListener(){
  const ref = db.ref('users');
  ref.on('value', snapshot=>{
    const val = snapshot.val() || {};
    const entries = Object.entries(val).map(([id,data]) => ({ id, ...data }));
    entries.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
    const recent = entries.slice(0,50);

    // æ›´æ–°ç”¨æˆ·æ•°
    userCountEl.textContent = entries.length;

    // æœ€æ–° BMI æ˜¾ç¤ºï¼ˆæœ€è¿‘ä¸€æ¡ï¼‰
    if (recent.length>0){
      const latest = recent[0];
      document.getElementById('greeting').innerHTML = `Hiï¼Œ${escapeHtml(latest.name||'ç”¨æˆ·')} Â· æœ€æ–° BMIï¼š<strong>${latest.bmi}</strong> Â· ${latest.category||''}`;
    } else {
      document.getElementById('greeting').innerHTML = 'ä¸ªæ€§åŒ–å¥åº·å»ºè®®';
    }

    // å¹´é¾„æ®µç»Ÿè®¡
    const groupCounts = ageGroups.map(()=>({ normal:0, over:0, total:0 }));
    entries.forEach(u=>{
      const age = Number(u.age) || 0;
      const bmi = Number(u.bmi) || 0;
      let idx = 0;
      if (age < 18) idx = 0;
      else if (age <= 30) idx = 1;
      else if (age <= 45) idx = 2;
      else if (age <= 60) idx = 3;
      else idx = 4;
      groupCounts[idx].total += 1;
      if (bmi >= 25) groupCounts[idx].over += 1;
      else groupCounts[idx].normal += 1;
    });

    const normalPerc = groupCounts.map(g => g.total ? Math.round(100 * (g.normal/g.total)) : 0);
    const overPerc = groupCounts.map(g => g.total ? Math.round(100 * (g.over/g.total)) : 0);

    ageChart.data.datasets[0].data = normalPerc;
    ageChart.data.datasets[1].data = overPerc;
    ageChart.update();

    // æ¸²æŸ“æœ€è¿‘ 50 æ¡è¡¨æ ¼
    renderTable(recent);
  });
}
attachRealtimeListener();

/* è¡¨æ ¼æ¸²æŸ“ */
function renderTable(list){
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `<table><thead><tr><th>å§“å</th><th>å¹´é¾„</th><th>èº«é«˜</th><th>ä½“é‡</th><th>BMI</th><th>åˆ†ç±»</th><th>æ—¶é—´</th></tr></thead><tbody></tbody></table>`;
  const tbody = wrapper.querySelector('tbody');
  list.forEach(item=>{
    const date = new Date(item.timestamp || Date.now());
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:700">${escapeHtml(item.name||'')}</td>
                    <td>${item.age||''}</td>
                    <td>${item.height||''}</td>
                    <td>${item.weight||''}</td>
                    <td>${item.bmi||''}</td>
                    <td>${item.category||''}</td>
                    <td class="small">${date.toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
  tableWrap.innerHTML = '';
  tableWrap.appendChild(wrapper);
}

/* é˜²æ³¨å…¥ç®€å•è½¬ä¹‰ */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ================= ä¿å­˜æ•°æ®åˆ° Firebase ================= */
saveBtn.addEventListener('click', ()=>{
  const name = nameInput.value.trim();
  const height = parseFloat(heightInput.value);
  const weight = parseFloat(weightInput.value);
  const age = parseInt(ageInput.value);

  if (!name || !height || !weight || !age){
    alert('è¯·å®Œæ•´å¡«å†™å§“åã€èº«é«˜ã€ä½“é‡å’Œå¹´é¾„ã€‚');
    return;
  }

  const { bmi, category } = calcBMI(weight, height);
  const record = {
    name, height, weight, age, bmi, category,
    timestamp: Date.now()
  };

  // push -> è‡ªåŠ¨ç”Ÿæˆ id
  const newRef = db.ref('users').push();
  newRef.set(record)
    .then(()=>{
      // æˆåŠŸåç«‹å³æ˜¾ç¤ºç”Ÿæˆå†…å®¹
      greeting.innerHTML = `Hiï¼Œ${escapeHtml(name)} ğŸ‘‹ Â· BMIï¼š<strong>${bmi}</strong> Â· ${category}`;
      bmiInfo.innerHTML = `<div class="small">æ¯æ—¥ä¼°ç®—èƒ½é‡éœ€æ±‚ä¸è†³é£ŸæŒ‰å¹´é¾„ä¸ä½“é‡çŠ¶æ€æ™ºèƒ½è°ƒæ•´ï¼ˆç¤ºä¾‹ç®—æ³•ï¼‰ã€‚</div>`;
      const meals = generateMeals(bmi, age);
      renderMealsAndTable(meals);
      // æ¸…ç©ºè¡¨å•ï¼ˆå¯é€‰ï¼‰
      // nameInput.value=''; heightInput.value=''; weightInput.value=''; ageInput.value='';
    })
    .catch(err=>{
      console.error('å†™å…¥å¤±è´¥ï¼š', err);
      alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase æ•°æ®åº“è§„åˆ™æˆ–ç½‘ç»œï¼ˆæ§åˆ¶å°æœ‰è¯¦ç»†é”™è¯¯ï¼‰ã€‚');
    });
});

/* æ¸…ç©ºè¡¨å• */
clearBtn.addEventListener('click', ()=>{
  nameInput.value=''; heightInput.value=''; weightInput.value=''; ageInput.value='';
  greeting.innerHTML = 'ä¸ªæ€§åŒ–å¥åº·å»ºè®®';
  bmiInfo.innerHTML = 'è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯å¹¶ä¿å­˜ä»¥æŸ¥çœ‹è¯¦ç»†å»ºè®®';
  mealsContainer.innerHTML = '';
  foodTableWrapper.innerHTML = '';
});

/* åˆå§‹åŒ–å ä½ç¤ºä¾‹ */
(function initDemo(){
  mealsContainer.innerHTML = `<div class="meal-item"><div style="font-weight:700">ç¤ºä¾‹ï¼šè¯·å¡«å†™ä¿¡æ¯å¹¶ä¿å­˜ä»¥è·å–ä¸ªæ€§åŒ–å»ºè®®</div></div>`;
  foodTableWrapper.innerHTML = `<div class="small">ä¿å­˜åå°†åœ¨æ­¤æ˜¾ç¤ºæ¯é“èœçš„çƒ­é‡ä¸è¥å…»è¦ç‚¹</div>`;
})();

</script>
</body>
</html>
