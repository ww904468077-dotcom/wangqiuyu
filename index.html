<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¥åº·æ™ºè†³ - ä¸ªæ€§åŒ–å¥åº·è†³é£ŸåŠ©æ‰‹</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Font Awesome å›¾æ ‡ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
  /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
  :root {
    --primary: #667eea;
    --primary-light: #7c8ef2;
    --primary-dark: #5a67d8;
    --secondary: #d53f8c;
    --success: #48bb78;
    --warning: #ed8936;
    --danger: #f56565;
    --info: #4299e1;
    --light: #f7fafc;
    --dark: #2d3748;
    --muted: #a0aec0;
    --border: #e2e8f0;
    
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
    --radius: 16px;
    --radius-sm: 10px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: var(--dark);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    margin-bottom: 30px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
  }

  .logo-text h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 4px;
  }

  .logo-text p {
    font-size: 0.875rem;
    color: var(--muted);
  }

  .header-stats {
    display: flex;
    gap: 20px;
  }

  .stat-item {
    text-align: center;
  }

  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* ç»ç’ƒæ€å¡ç‰‡ */
  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .glass-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  /* ç½‘æ ¼å¸ƒå±€ */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
  }

  @media (max-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }

  /* è¡¨å•æ ·å¼ */
  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dark);
    margin-bottom: 8px;
  }

  .form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    transition: all 0.2s;
    background: white;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  /* æŒ‰é’®æ ·å¼ */
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .btn-secondary {
    background: white;
    color: var(--dark);
    border: 2px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 8px;
  }

  /* BMIæŒ‡ç¤ºå™¨ */
  .bmi-indicator {
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f6f9fc 0%, #edf2f7 100%);
    border-radius: var(--radius-sm);
  }

  .bmi-value {
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .bmi-status {
    text-align: center;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 999px;
    display: inline-block;
    font-size: 0.875rem;
  }

  .bmi-normal { background: rgba(72, 187, 120, 0.1); color: var(--success); }
  .bmi-overweight { background: rgba(237, 137, 54, 0.1); color: var(--warning); }
  .bmi-obese { background: rgba(245, 101, 101, 0.1); color: var(--danger); }
  .bmi-underweight { background: rgba(66, 153, 225, 0.1); color: var(--info); }

  /* è¿›åº¦æ¡ */
  .progress-bar {
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin: 20px 0;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  /* å†…å®¹åŒºåŸŸ */
  .content-area {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  @media (max-width: 768px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  /* è†³é£Ÿå»ºè®®å¡ç‰‡ */
  .meal-card {
    padding: 0;
  }

  .meal-header {
    padding: 20px 20px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .meal-list {
    padding: 20px;
  }

  .meal-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }

  .meal-item:last-child {
    border-bottom: none;
  }

  .meal-name {
    font-weight: 500;
  }

  .meal-calories {
    color: var(--primary);
    font-weight: 600;
  }

  /* å›¾è¡¨å®¹å™¨ */
  .chart-container {
    padding: 20px;
    position: relative;
    height: 300px;
  }

  /* è¡¨æ ¼æ ·å¼ */
  .data-table {
    padding: 20px;
  }

  .table-container {
    max-height: 300px;
    overflow-y: auto;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    background: var(--light);
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    position: sticky;
    top: 0;
  }

  td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  tr:hover {
    background: var(--light);
  }

  /* çŠ¶æ€æç¤º */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .status-online {
    background: rgba(72, 187, 120, 0.1);
    color: var(--success);
  }

  .status-offline {
    background: rgba(245, 101, 101, 0.1);
    color: var(--danger);
  }

  /* ç©ºçŠ¶æ€ */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* å›¾è¡¨æŒ‰é’®ç»„ */
  .chart-controls {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .chart-btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--dark);
    transition: all 0.2s;
  }

  .chart-btn:hover {
    background: var(--light);
  }

  .chart-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      gap: 20px;
    }
    
    .header-stats {
      width: 100%;
      justify-content: space-around;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-heartbeat"></i>
        </div>
        <div class="logo-text">
          <h1>å¥åº·æ™ºè†³</h1>
          <p>ä¸ªæ€§åŒ–å¥åº·è†³é£ŸåŠ©æ‰‹</p>
        </div>
      </div>
      
      <div class="header-stats">
        <div class="stat-item">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="onlineUsers">0</div>
          <div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="avgBMI">-</div>
          <div class="stat-label">å¹³å‡BMI</div>
        </div>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="dashboard-grid">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯è¾“å…¥ -->
      <div class="sidebar">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="glass-card user-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">ä¸ªäººå¥åº·æ¡£æ¡ˆ</h2>
              <p class="card-subtitle">å¡«å†™åŸºæœ¬ä¿¡æ¯è·å–ä¸ªæ€§åŒ–å»ºè®®</p>
            </div>
            <div class="user-avatar">
              <i class="fas fa-user"></i>
            </div>
          </div>

          <form id="healthForm">
            <div class="form-group">
              <label class="form-label">å§“å</label>
              <input type="text" id="name" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">å¹´é¾„</label>
                <input type="number" id="age" class="form-input" placeholder="å²" min="1" max="120">
              </div>
              <div class="form-group">
                <label class="form-label">æ€§åˆ«</label>
                <select id="gender" class="form-input">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="male">ç”·æ€§</option>
                  <option value="female">å¥³æ€§</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">èº«é«˜ (cm)</label>
                <input type="number" id="height" class="form-input" placeholder="å˜ç±³" min="50" max="250" step="0.1">
              </div>
              <div class="form-group">
                <label class="form-label">ä½“é‡ (kg)</label>
                <input type="number" id="weight" class="form-input" placeholder="åƒå…‹" min="20" max="300" step="0.1">
              </div>
            </div>

            <!-- BMI æŒ‡ç¤ºå™¨ -->
            <div class="bmi-indicator" id="bmiDisplay" style="display: none;">
              <div class="bmi-value" id="bmiValue">-</div>
              <div id="bmiStatus" class="bmi-status"></div>
              <div class="progress-bar">
                <div class="progress-fill" id="bmiProgress" style="width: 0%"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); margin-top: 4px;">
                <span>åç˜¦ (<18.5)</span>
                <span>æ­£å¸¸ (18.5-24)</span>
                <span>è¶…é‡ (24-28)</span>
                <span>è‚¥èƒ– (>28)</span>
              </div>
            </div>

            <div class="btn-group">
              <button type="button" id="saveBtn" class="btn btn-primary">
                <i class="fas fa-save"></i>ä¿å­˜å¹¶åˆ†æ
              </button>
              <button type="button" id="clearBtn" class="btn btn-secondary">
                <i class="fas fa-redo"></i>é‡æ–°å¡«å†™
              </button>
            </div>
          </form>
        </div>

        <!-- å®æ—¶ç»Ÿè®¡æ•°æ® -->
        <div class="glass-card">
          <div class="card-header">
            <h2 class="card-title">å®æ—¶ç»Ÿè®¡</h2>
            <span class="status-badge status-online" id="connectionStatus">
              <i class="fas fa-circle"></i>å·²è¿æ¥
            </span>
          </div>
          <div class="stats-grid" style="padding: 20px;">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-number" id="todayUsers">0</div>
              <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <div class="stat-number" id="normalUsers">0%</div>
              <div class="stat-label">å¥åº·æ¯”ä¾‹</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-running"></i>
              </div>
              <div class="stat-number" id="activeUsers">0</div>
              <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šåˆ†æç»“æœ -->
      <div class="content-area">
        <!-- è†³é£Ÿå»ºè®® -->
        <div class="glass-card meal-card">
          <div class="meal-header">
            <h2 class="card-title">ä»Šæ—¥è†³é£Ÿå»ºè®®</h2>
            <span class="stat-label" id="dailyCalories">å»ºè®®æ€»çƒ­é‡: - kcal</span>
          </div>
          <div class="meal-list">
            <div class="empty-state" id="mealPlaceholder">
              <i class="fas fa-utensils"></i>
              <p>å¡«å†™ä¿¡æ¯è·å–ä¸ªæ€§åŒ–è†³é£Ÿå»ºè®®</p>
            </div>
            <div id="mealsContainer" style="display: none;">
              <!-- è†³é£Ÿå»ºè®®åŠ¨æ€æ’å…¥ -->
            </div>
          </div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div class="glass-card">
          <div class="card-header">
            <h2 class="card-title">å¥åº·æ•°æ®ç»Ÿè®¡</h2>
            <div class="chart-controls">
              <button class="chart-btn active" onclick="changeChartType('age')" id="btnAgeChart">
                <i class="fas fa-chart-bar"></i>å¹´é¾„åˆ†å¸ƒ
              </button>
              <button class="chart-btn" onclick="changeChartType('bmi')" id="btnBmiChart">
                <i class="fas fa-chart-pie"></i>BMIåˆ†å¸ƒ
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="healthChart"></canvas>
          </div>
        </div>

        <!-- ç”¨æˆ·æ•°æ®è¡¨æ ¼ -->
        <div class="glass-card data-table">
          <div class="card-header">
            <h2 class="card-title">æœ€è¿‘ç”¨æˆ·æ•°æ®</h2>
            <input type="text" id="searchInput" class="form-input" placeholder="æœç´¢ç”¨æˆ·..." style="width: 200px; padding: 8px 12px;">
          </div>
          <div class="table-container">
            <table id="userTable">
              <thead>
                <tr>
                  <th>å§“å</th>
                  <th>å¹´é¾„</th>
                  <th>BMI</th>
                  <th>çŠ¶æ€</th>
                  <th>è®°å½•æ—¶é—´</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr>
                  <td colspan="5" class="empty-state">
                    <i class="fas fa-database"></i>
                    <p>æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ ç¬¬ä¸€æ¡è®°å½•</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ================= å…¨å±€å˜é‡ =================
let healthChart = null;
let allUsersData = [];
let isOnline = false;
let currentChartType = 'age';

// ================= DOM å…ƒç´  =================
const elements = {
  // è¡¨å•å…ƒç´ 
  name: document.getElementById('name'),
  age: document.getElementById('age'),
  gender: document.getElementById('gender'),
  height: document.getElementById('height'),
  weight: document.getElementById('weight'),
  saveBtn: document.getElementById('saveBtn'),
  clearBtn: document.getElementById('clearBtn'),
  
  // æ˜¾ç¤ºå…ƒç´ 
  bmiDisplay: document.getElementById('bmiDisplay'),
  bmiValue: document.getElementById('bmiValue'),
  bmiStatus: document.getElementById('bmiStatus'),
  bmiProgress: document.getElementById('bmiProgress'),
  
  // ç»Ÿè®¡æ•°æ®
  totalUsers: document.getElementById('totalUsers'),
  onlineUsers: document.getElementById('onlineUsers'),
  avgBMI: document.getElementById('avgBMI'),
  todayUsers: document.getElementById('todayUsers'),
  normalUsers: document.getElementById('normalUsers'),
  activeUsers: document.getElementById('activeUsers'),
  connectionStatus: document.getElementById('connectionStatus'),
  
  // è†³é£Ÿå»ºè®®å…ƒç´ 
  dailyCalories: document.getElementById('dailyCalories'),
  mealPlaceholder: document.getElementById('mealPlaceholder'),
  mealsContainer: document.getElementById('mealsContainer'),
  
  // è¡¨æ ¼å…ƒç´ 
  userTableBody: document.getElementById('userTableBody'),
  searchInput: document.getElementById('searchInput'),
  
  // å›¾è¡¨æ§åˆ¶æŒ‰é’®
  btnAgeChart: document.getElementById('btnAgeChart'),
  btnBmiChart: document.getElementById('btnBmiChart')
};

// ================= åˆå§‹åŒ– =================
document.addEventListener('DOMContentLoaded', function() {
  console.log('åº”ç”¨åˆå§‹åŒ–...');
  
  // åˆå§‹åŒ–è¡¨å•è¾“å…¥ç›‘å¬
  setupFormListeners();
  
  // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
  elements.saveBtn.addEventListener('click', saveHealthData);
  elements.clearBtn.addEventListener('click', clearForm);
  elements.searchInput.addEventListener('input', filterUsers);
  
  // åˆå§‹åŒ–å›¾è¡¨
  initHealthChart();
  
  // æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
  showSampleData();
  
  // æ›´æ–°è¿æ¥çŠ¶æ€
  updateConnectionStatus();
  
  console.log('åˆå§‹åŒ–å®Œæˆ');
});

// ================= è¡¨å•ç›‘å¬ =================
function setupFormListeners() {
  console.log('è®¾ç½®è¡¨å•ç›‘å¬...');
  const inputs = ['height', 'weight', 'age'];
  inputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', calculateBMI);
    }
  });
  console.log('è¡¨å•ç›‘å¬è®¾ç½®å®Œæˆ');
}

// ================= BMIè®¡ç®— =================
function calculateBMI() {
  console.log('è®¡ç®—BMI...');
  const height = parseFloat(elements.height.value);
  const weight = parseFloat(elements.weight.value);
  const age = parseInt(elements.age.value);
  
  if (height && weight && age) {
    const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
    const category = getBMICategory(bmi);
    
    console.log(`è®¡ç®—å®Œæˆ: BMI=${bmi}, åˆ†ç±»=${category.text}`);
    
    // æ›´æ–°BMIæ˜¾ç¤º
    elements.bmiDisplay.style.display = 'block';
    elements.bmiValue.textContent = bmi;
    elements.bmiStatus.textContent = category.text;
    elements.bmiStatus.className = `bmi-status bmi-${category.type}`;
    
    // æ›´æ–°è¿›åº¦æ¡
    let progressPercent = 0;
    if (bmi < 18.5) {
      progressPercent = (bmi / 18.5) * 25; // åç˜¦åŒºé—´å 25%
    } else if (bmi < 24) {
      progressPercent = 25 + ((bmi - 18.5) / (24 - 18.5)) * 25; // æ­£å¸¸åŒºé—´å 25%
    } else if (bmi < 28) {
      progressPercent = 50 + ((bmi - 24) / (28 - 24)) * 25; // è¶…é‡åŒºé—´å 25%
    } else {
      progressPercent = 75 + Math.min(((bmi - 28) / 10) * 25, 25); // è‚¥èƒ–åŒºé—´å 25%
    }
    
    elements.bmiProgress.style.width = `${Math.min(progressPercent, 100)}%`;
    
    // è®¾ç½®è¿›åº¦æ¡é¢œè‰²
    if (category.type === 'underweight') {
      elements.bmiProgress.style.background = 'linear-gradient(90deg, var(--info), var(--primary))';
    } else if (category.type === 'normal') {
      elements.bmiProgress.style.background = 'linear-gradient(90deg, var(--success), var(--success-light))';
    } else if (category.type === 'overweight') {
      elements.bmiProgress.style.background = 'linear-gradient(90deg, var(--warning), var(--warning-dark))';
    } else {
      elements.bmiProgress.style.background = 'linear-gradient(90deg, var(--danger), var(--danger-dark))';
    }
  } else {
    console.log('æ•°æ®ä¸è¶³ï¼Œéšè—BMIæ˜¾ç¤º');
    elements.bmiDisplay.style.display = 'none';
  }
}

function getBMICategory(bmi) {
  bmi = parseFloat(bmi);
  if (bmi < 18.5) return { type: 'underweight', text: 'åç˜¦' };
  if (bmi < 24) return { type: 'normal', text: 'æ­£å¸¸' };
  if (bmi < 28) return { type: 'overweight', text: 'è¶…é‡' };
  return { type: 'obese', text: 'è‚¥èƒ–' };
}

// ================= æ•°æ®ä¿å­˜ =================
async function saveHealthData() {
  console.log('ä¿å­˜å¥åº·æ•°æ®...');
  const data = collectFormData();
  console.log('æ”¶é›†çš„æ•°æ®:', data);
  
  if (!validateData(data)) {
    console.log('æ•°æ®éªŒè¯å¤±è´¥');
    return;
  }
  
  // è®¡ç®—BMI
  data.bmi = calculateBMINumber(data);
  data.category = getBMICategory(data.bmi).type;
  data.timestamp = Date.now();
  data.id = generateUserId();
  console.log('å¤„ç†åæ•°æ®:', data);
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const originalText = elements.saveBtn.innerHTML;
  elements.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
  elements.saveBtn.disabled = true;
  
  try {
    // æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
    allUsersData.push(data);
    console.log('å·²æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨ï¼Œæ€»æ•°:', allUsersData.length);
    
    // æ›´æ–°æœ¬åœ°å­˜å‚¨
    saveToLocalStorage(data);
    console.log('å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
    
    // æ›´æ–°UI
    updateUIAfterSave(data);
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showSuccessMessage('æ•°æ®ä¿å­˜æˆåŠŸï¼');
    console.log('UIæ›´æ–°å®Œæˆ');
    
  } catch (error) {
    console.error('ä¿å­˜å¤±è´¥:', error);
    showErrorMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    elements.saveBtn.innerHTML = originalText;
    elements.saveBtn.disabled = false;
  }
}

function collectFormData() {
  return {
    name: elements.name.value.trim(),
    age: parseInt(elements.age.value) || 0,
    gender: elements.gender.value,
    height: parseFloat(elements.height.value) || 0,
    weight: parseFloat(elements.weight.value) || 0
  };
}

function validateData(data) {
  if (!data.name) {
    showErrorMessage('è¯·è¾“å…¥å§“å');
    return false;
  }
  if (!data.age || data.age < 1 || data.age > 120) {
    showErrorMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„ï¼ˆ1-120ï¼‰');
    return false;
  }
  if (!data.height || data.height < 50 || data.height > 250) {
    showErrorMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„èº«é«˜ï¼ˆ50-250 cmï¼‰');
    return false;
  }
  if (!data.weight || data.weight < 20 || data.weight > 300) {
    showErrorMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“é‡ï¼ˆ20-300 kgï¼‰');
    return false;
  }
  return true;
}

function calculateBMINumber(data) {
  return (data.weight / ((data.height / 100) ** 2)).toFixed(1);
}

function generateUserId() {
  return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ================= æ¶ˆæ¯æç¤º =================
function showSuccessMessage(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    background: var(--success);
    color: white;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow);
    z-index: 1000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showErrorMessage(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    background: var(--danger);
    color: white;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow);
    z-index: 1000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// æ·»åŠ åŠ¨ç”»CSS
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ================= å›¾è¡¨åŠŸèƒ½ =================
function initHealthChart() {
  console.log('åˆå§‹åŒ–å›¾è¡¨...');
  const ctx = document.getElementById('healthChart');
  if (!ctx) {
    console.error('å›¾è¡¨ç”»å¸ƒæœªæ‰¾åˆ°');
    return;
  }
  
  try {
    // åˆ›å»ºå›¾è¡¨
    healthChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['é’å°‘å¹´(<18)', 'é’å¹´(18-30)', 'ä¸­å¹´(31-45)', 'ä¸­è€å¹´(46-60)', 'è€å¹´(60+)'],
        datasets: [{
          label: 'ç”¨æˆ·æ•°é‡',
          data: [0, 0, 0, 0, 0],
          backgroundColor: [
            'rgba(102, 126, 234, 0.6)',
            'rgba(72, 187, 120, 0.6)',
            'rgba(237, 137, 54, 0.6)',
            'rgba(66, 153, 225, 0.6)',
            'rgba(210, 82, 140, 0.6)'
          ],
          borderColor: [
            'rgb(102, 126, 234)',
            'rgb(72, 187, 120)',
            'rgb(237, 137, 54)',
            'rgb(66, 153, 225)',
            'rgb(210, 82, 140)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: 'var(--dark)',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            padding: 12,
            cornerRadius: 6
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              color: 'var(--muted)',
              callback: function(value) {
                return Number.isInteger(value) ? value : '';
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              color: 'var(--dark)',
              maxRotation: 45
            }
          }
        }
      }
    });
    
    console.log('å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
    
  } catch (error) {
    console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

function changeChartType(type) {
  console.log('åˆ‡æ¢å›¾è¡¨ç±»å‹:', type);
  currentChartType = type;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  if (elements.btnAgeChart) elements.btnAgeChart.classList.toggle('active', type === 'age');
  if (elements.btnBmiChart) elements.btnBmiChart.classList.toggle('active', type === 'bmi');
  
  if (type === 'age') {
    updateAgeDistributionChart();
  } else {
    updateBMIDistributionChart();
  }
}

function updateChart() {
  if (currentChartType === 'age') {
    updateAgeDistributionChart();
  } else {
    updateBMIDistributionChart();
  }
}

function updateAgeDistributionChart() {
  console.log('æ›´æ–°å¹´é¾„åˆ†å¸ƒå›¾è¡¨...');
  if (!healthChart) return;
  
  const ageGroups = {
    'é’å°‘å¹´(<18)': 0,
    'é’å¹´(18-30)': 0,
    'ä¸­å¹´(31-45)': 0,
    'ä¸­è€å¹´(46-60)': 0,
    'è€å¹´(60+)': 0
  };
  
  allUsersData.forEach(user => {
    const group = getAgeGroup(user.age);
    ageGroups[group] = (ageGroups[group] || 0) + 1;
  });
  
  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®
  const hasData = allUsersData.length > 0;
  const labels = Object.keys(ageGroups);
  const data = hasData ? Object.values(ageGroups) : [5, 8, 3, 2, 1];
  const labelText = hasData ? 'ç”¨æˆ·æ•°é‡' : 'ç¤ºä¾‹æ•°æ®';
  
  healthChart.data.labels = labels;
  healthChart.data.datasets[0].data = data;
  healthChart.data.datasets[0].label = labelText;
  healthChart.config.type = 'bar';
  
  healthChart.options.plugins.title = {
    display: true,
    text: hasData ? 'ç”¨æˆ·å¹´é¾„åˆ†å¸ƒ' : 'å¹´é¾„åˆ†å¸ƒï¼ˆç¤ºä¾‹ï¼‰',
    color: 'var(--dark)',
    font: {
      size: 16,
      weight: 'bold'
    }
  };
  
  healthChart.update();
  console.log('å¹´é¾„åˆ†å¸ƒå›¾è¡¨æ›´æ–°å®Œæˆ');
}

function updateBMIDistributionChart() {
  console.log('æ›´æ–°BMIåˆ†å¸ƒå›¾è¡¨...');
  if (!healthChart) return;
  
  const bmiCategories = {
    'åç˜¦(<18.5)': 0,
    'æ­£å¸¸(18.5-24)': 0,
    'è¶…é‡(24-28)': 0,
    'è‚¥èƒ–(>28)': 0
  };
  
  allUsersData.forEach(user => {
    if (user.bmi) {
      const bmi = parseFloat(user.bmi);
      if (bmi < 18.5) bmiCategories['åç˜¦(<18.5)']++;
      else if (bmi < 24) bmiCategories['æ­£å¸¸(18.5-24)']++;
      else if (bmi < 28) bmiCategories['è¶…é‡(24-28)']++;
      else bmiCategories['è‚¥èƒ–(>28)']++;
    }
  });
  
  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®
  const hasData = allUsersData.length > 0;
  const labels = Object.keys(bmiCategories);
  const data = hasData ? Object.values(bmiCategories) : [2, 8, 4, 1];
  const labelText = hasData ? 'BMIåˆ†å¸ƒ' : 'BMIåˆ†å¸ƒï¼ˆç¤ºä¾‹ï¼‰';
  
  healthChart.data.labels = labels;
  healthChart.data.datasets[0].data = data;
  healthChart.data.datasets[0].label = labelText;
  healthChart.config.type = 'pie';
  healthChart.data.datasets[0].backgroundColor = [
    'rgba(66, 153, 225, 0.6)',  // åç˜¦
    'rgba(72, 187, 120, 0.6)',  // æ­£å¸¸
    'rgba(237, 137, 54, 0.6)',  // è¶…é‡
    'rgba(245, 101, 101, 0.6)'  // è‚¥èƒ–
  ];
  
  healthChart.options.plugins.title = {
    display: true,
    text: hasData ? 'BMIåˆ†å¸ƒç»Ÿè®¡' : 'BMIåˆ†å¸ƒï¼ˆç¤ºä¾‹ï¼‰',
    color: 'var(--dark)',
    font: {
      size: 16,
      weight: 'bold'
    }
  };
  
  healthChart.update();
  console.log('BMIåˆ†å¸ƒå›¾è¡¨æ›´æ–°å®Œæˆ');
}

function getAgeGroup(age) {
  if (age < 18) return 'é’å°‘å¹´(<18)';
  if (age <= 30) return 'é’å¹´(18-30)';
  if (age <= 45) return 'ä¸­å¹´(31-45)';
  if (age <= 60) return 'ä¸­è€å¹´(46-60)';
  return 'è€å¹´(60+)';
}

// ================= è¡¨æ ¼åŠŸèƒ½ =================
function filterUsers() {
  const searchTerm = elements.searchInput.value.toLowerCase();
  const rows = elements.userTableBody.querySelectorAll('tr');
  
  rows.forEach(row => {
    if (row.classList && row.classList.contains('empty-state')) return;
    
    const text = row.textContent.toLowerCase();
    row.style.display = searchTerm === '' || text.includes(searchTerm) ? '' : 'none';
  });
}

// ================= å¢å¼ºçš„è†³é£Ÿå»ºè®® =================
function updateUIAfterSave(data) {
  console.log('æ›´æ–°UIï¼Œæ•°æ®:', data);
  
  // æ›´æ–°è†³é£Ÿå»ºè®®
  showEnhancedDietAdvice(data);
  
  // æ›´æ–°ç”¨æˆ·æ•°æ®åˆ—è¡¨
  addUserToTable(data);
  
  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  updateStatistics();
  
  // æ›´æ–°å›¾è¡¨
  updateChart();
  
  // è®¡ç®—BMI
  const bmi = data.bmi || calculateBMINumber(data);
  const category = getBMICategory(bmi);
  elements.bmiDisplay.style.display = 'block';
  elements.bmiValue.textContent = bmi;
  elements.bmiStatus.textContent = category.text;
  elements.bmiStatus.className = `bmi-status bmi-${category.type}`;
  
  // æ›´æ–°è¿›åº¦æ¡
  let progressPercent = 0;
  if (bmi < 18.5) {
    progressPercent = (bmi / 18.5) * 25;
  } else if (bmi < 24) {
    progressPercent = 25 + ((bmi - 18.5) / (24 - 18.5)) * 25;
  } else if (bmi < 28) {
    progressPercent = 50 + ((bmi - 24) / (28 - 24)) * 25;
  } else {
    progressPercent = 75 + Math.min(((bmi - 28) / 10) * 25, 25);
  }
  elements.bmiProgress.style.width = `${Math.min(progressPercent, 100)}%`;
  
  console.log('UIæ›´æ–°å®Œæˆ');
}

function showEnhancedDietAdvice(data) {
  const age = data.age || 30;
  const bmi = data.bmi || 22;
  const gender = data.gender || 'male';
  const height = data.height || 170;
  const weight = data.weight || 65;
  
  const dietPlan = getDietPlan(age, bmi, gender, height, weight);
  const ageGroup = getAgeGroup(age);
  const bmiCategory = getBMICategory(bmi).type;
  
  console.log('ç”Ÿæˆè†³é£Ÿå»ºè®®:', { ageGroup, bmiCategory, dietPlan });
  
  // æ›´æ–°æ€»çƒ­é‡æ˜¾ç¤º
  elements.dailyCalories.textContent = `å»ºè®®æ€»çƒ­é‡: ${dietPlan.dailyCalories} kcal`;
  
  // ç”ŸæˆHTML
  let html = `
    <div style="margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="font-size: 1.1rem; color: var(--primary);">${ageGroup} ä¸ªæ€§åŒ–è†³é£Ÿè®¡åˆ’</h3>
        <div style="font-size: 0.9rem; color: var(--muted);">
          <div>BMR: <strong>${dietPlan.bmr}</strong> kcal</div>
          <div>TDEE: <strong>${dietPlan.tdee}</strong> kcal</div>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(210, 82, 140, 0.1)); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
        <h4 style="color: var(--primary); margin-bottom: 12px;">ğŸ½ï¸ é¤æ¬¡åˆ†é…</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
          <div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary);">æ—©é¤</div>
            <div style="font-size: 0.9rem; color: var(--muted);">${dietPlan.mealPlan.breakfast.totalCalories} kcal</div>
          </div>
          <div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);">åˆé¤</div>
            <div style="font-size: 0.9rem; color: var(--muted);">${dietPlan.mealPlan.lunch.totalCalories} kcal</div>
          </div>
          <div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--warning);">æ™šé¤</div>
            <div style="font-size: 0.9rem; color: var(--muted);">${dietPlan.mealPlan.dinner.totalCalories} kcal</div>
          </div>
          <div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--info);">åŠ é¤</div>
            <div style="font-size: 0.9rem; color: var(--muted);">${dietPlan.mealPlan.snacks.totalCalories} kcal</div>
          </div>
        </div>
      </div>
  `;
  
  // æ—©é¤å»ºè®®
  html += `
    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h4 style="font-size: 1.1rem; color: var(--primary);">ğŸŒ… æ—©é¤å»ºè®®</h4>
        <span style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 4px 12px; border-radius: 999px; font-size: 0.9rem;">
          ${dietPlan.mealPlan.breakfast.totalCalories} kcal
        </span>
      </div>
  `;
  
  dietPlan.mealPlan.breakfast.foods.forEach(food => {
    html += `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed var(--border);">
        <div>
          <div style="font-weight: 500;">${food.name}</div>
          <div style="font-size: 0.85rem; color: var(--muted);">${food.note}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-weight: 600; color: var(--primary);">${food.calories} kcal</div>
          <div style="font-size: 0.8rem; color: var(--muted);">${food.nutrition}</div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // è¥å…»ç›®æ ‡
  html += `
    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px;">
      <h4 style="font-size: 1.1rem; color: var(--primary); margin-bottom: 12px;">ğŸ¯ è¥å…»ç›®æ ‡</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
  `;
  
  const nutritionGoals = dietPlan.nutritionGoals || {};
  Object.entries(nutritionGoals).forEach(([key, goal]) => {
    html += `
      <div style="padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.02);">
        <div style="font-weight: 500; font-size: 0.9rem;">${getNutritionName(key)}</div>
        <div style="font-size: 0.8rem; color: var(--muted);">${goal.min} - ${goal.max} ${goal.unit}</div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  elements.mealPlaceholder.style.display = 'none';
  elements.mealsContainer.style.display = 'block';
  elements.mealsContainer.innerHTML = html;
}

function getNutritionName(key) {
  const names = {
    protein: 'è›‹ç™½è´¨',
    carbs: 'ç¢³æ°´åŒ–åˆç‰©',
    fat: 'è„‚è‚ª',
    fiber: 'è†³é£Ÿçº¤ç»´',
    water: 'æ°´åˆ†',
    calcium: 'é’™è´¨',
    iron: 'é“è´¨',
    vitaminD: 'ç»´ç”Ÿç´ D',
    zinc: 'é”Œ'
  };
  return names[key] || key;
}

function getDietPlan(age, bmi, gender, height, weight) {
  const ageGroup = getAgeGroup(age);
  const bmiNum = parseFloat(bmi);
  const bmiCategory = getBMICategory(bmi).type;
  const genderFactor = gender === 'female' ? 0.9 : 1.0;
  
  // è®¡ç®—åŸºç¡€ä»£è°¢ç‡ (BMR) ä½¿ç”¨Mifflin-St Jeorå…¬å¼
  let bmr = 0;
  if (gender === 'male') {
    bmr = 10 * weight + 6.25 * height - 5 * age + 5;
  } else {
    bmr = 10 * weight + 6.25 * height - 5 * age - 161;
  }
  bmr = Math.round(bmr);
  
  // è®¡ç®—æ¯æ—¥æ€»èƒ½é‡æ¶ˆè€— (TDEE)
  let activityFactor = 1.375; // è½»åº¦æ´»åŠ¨
  
  // æ ¹æ®BMIè°ƒæ•´
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    activityFactor = 1.2; // ä½æ´»åŠ¨
  } else if (bmiCategory === 'underweight') {
    activityFactor = 1.55; // ä¸­åº¦æ´»åŠ¨
  }
  
  // æ ¹æ®å¹´é¾„è°ƒæ•´
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    activityFactor = 1.7; // é’å°‘å¹´æ´»åŠ¨é‡æ›´å¤§
  } else if (ageGroup === 'è€å¹´(60+)') {
    activityFactor = 1.2; // è€å¹´äººæ´»åŠ¨é‡è¾ƒå°
  }
  
  const tdee = Math.round(bmr * activityFactor);
  
  // æ ¹æ®BMIè°ƒæ•´ç›®æ ‡çƒ­é‡
  let targetCalories = tdee;
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    targetCalories = Math.round(tdee * 0.85); // å‡é‡
  } else if (bmiCategory === 'underweight') {
    targetCalories = Math.round(tdee * 1.15); // å¢é‡
  }
  
  // é¤æ¬¡åˆ†é…
  const mealDistribution = getMealDistribution(ageGroup, bmiCategory);
  const breakfastCal = Math.round(targetCalories * mealDistribution.breakfast);
  const lunchCal = Math.round(targetCalories * mealDistribution.lunch);
  const dinnerCal = Math.round(targetCalories * mealDistribution.dinner);
  const snacksCal = Math.round(targetCalories * mealDistribution.snacks);
  
  return {
    dailyCalories: targetCalories,
    bmr: bmr,
    tdee: tdee,
    mealPlan: {
      breakfast: generateMeal('breakfast', ageGroup, bmiCategory, breakfastCal, gender),
      lunch: generateMeal('lunch', ageGroup, bmiCategory, lunchCal, gender),
      dinner: generateMeal('dinner', ageGroup, bmiCategory, dinnerCal, gender),
      snacks: generateSnacks(ageGroup, bmiCategory, snacksCal, gender)
    },
    nutritionGoals: getNutritionGoals(ageGroup, bmiCategory, gender),
    specialRecommendations: getSpecialRecommendations(ageGroup, bmiCategory, gender)
  };
}

function getMealDistribution(ageGroup, bmiCategory) {
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    return { breakfast: 0.3, lunch: 0.4, dinner: 0.25, snacks: 0.05 }; // æ™šé¤è¾ƒå°‘
  } else if (bmiCategory === 'underweight') {
    return { breakfast: 0.25, lunch: 0.35, dinner: 0.3, snacks: 0.1 }; // å¢åŠ åŠ é¤
  } else if (ageGroup === 'é’å°‘å¹´(<18)') {
    return { breakfast: 0.25, lunch: 0.4, dinner: 0.3, snacks: 0.05 }; // åˆé¤å¤š
  } else if (ageGroup === 'è€å¹´(60+)') {
    return { breakfast: 0.3, lunch: 0.35, dinner: 0.3, snacks: 0.05 }; // å‡åˆ†
  } else {
    return { breakfast: 0.3, lunch: 0.4, dinner: 0.25, snacks: 0.05 }; // æ ‡å‡†
  }
}

function generateMeal(mealType, ageGroup, bmiCategory, calories, gender) {
  const mealCalories = calories;
  const foods = getFoodOptions(mealType, ageGroup, bmiCategory, gender);
  
  // æ™ºèƒ½é€‰æ‹©é£Ÿç‰©ç»„åˆ
  const selectedFoods = [];
  let remainingCalories = mealCalories;
  let targetFoodCount = 3; // æ¯é¤å»ºè®®3ç§é£Ÿç‰©
  
  // æ ¹æ®çƒ­é‡åˆ†é…é€‰æ‹©é£Ÿç‰©
  for (let i = 0; i < targetFoodCount && remainingCalories > 100 && foods.length > 0; i++) {
    const availableFoods = foods.filter(f => f.calories <= remainingCalories);
    if (availableFoods.length === 0) break;
    
    // æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©é£Ÿç‰©
    const food = availableFoods.sort((a, b) => (b.priority || 0) - (a.priority || 0))[0];
    selectedFoods.push(food);
    remainingCalories -= food.calories;
    
    // ä»å¤‡é€‰åˆ—è¡¨ä¸­ç§»é™¤å·²é€‰é£Ÿç‰©
    const index = foods.indexOf(food);
    if (index > -1) foods.splice(index, 1);
  }
  
  return {
    totalCalories: mealCalories - remainingCalories,
    foods: selectedFoods
  };
}

function getFoodOptions(mealType, ageGroup, bmiCategory, gender) {
  const foods = {
    breakfast: [
      { name: 'ç‡•éº¦ç‰›å¥¶ç²¥ + åšæœ', calories: 350, nutrition: 'P:12g C:45g F:8g', note: 'é«˜çº¤ç»´ä¸å¥åº·è„‚è‚ª', priority: 5 },
      { name: 'å…¨éº¦é¢åŒ…+é¸¡è›‹+ç‰›å¥¶', calories: 320, nutrition: 'P:20g C:40g F:10g', note: 'ä¼˜è´¨è›‹ç™½+å¤åˆç¢³æ°´', priority: 4 },
      { name: 'è”¬èœé¸¡è›‹é¥¼+è±†æµ†', calories: 280, nutrition: 'P:15g C:20g F:12g', note: 'é«˜è›‹ç™½ä½GI', priority: 4 },
      { name: 'ç‰ç±³+é¸¡èƒ¸è‚‰+è”¬èœæ±', calories: 300, nutrition: 'P:25g C:35g F:8g', note: 'å¥èº«æ¨è', priority: 3 }
    ],
    lunch: [
      { name: 'æ‚ç²®é¥­+æ¸…è’¸é±¼+è¥¿å…°èŠ±', calories: 450, nutrition: 'P:30g C:50g F:12g', note: 'ä½è„‚é«˜è›‹ç™½', priority: 5 },
      { name: 'ç³™ç±³é¥­+ç‰›è‚‰+ç‚’è”¬èœ', calories: 480, nutrition: 'P:35g C:55g F:15g', note: 'å¢è‚Œæ¨è', priority: 4 },
      { name: 'èéº¦é¢+é¸¡èƒ¸è‚‰+è”¬èœæ²™æ‹‰', calories: 420, nutrition: 'P:28g C:45g F:10g', note: 'ä½GIé«˜çº¤ç»´', priority: 4 },
      { name: 'å…¨éº¦ä¸‰æ˜æ²»+æ²™æ‹‰', calories: 380, nutrition: 'P:20g C:40g F:12g', note: 'ä¾¿æºå¿«é€Ÿ', priority: 3 }
    ],
    dinner: [
      { name: 'è’¸çº¢è–¯+ä¸‰æ–‡é±¼+é’èœ', calories: 350, nutrition: 'P:25g C:30g F:10g', note: 'ä¼˜è´¨è„‚è‚ª', priority: 5 },
      { name: 'è±†è…æ±¤+å°‘é‡ç±³é¥­+è”¬èœ', calories: 320, nutrition: 'P:18g C:35g F:8g', note: 'æ¸…æ·¡æ˜“æ¶ˆåŒ–', priority: 4 },
      { name: 'é¸¡èƒ¸è‚‰æ²™æ‹‰+å…¨éº¦é¢åŒ…', calories: 300, nutrition: 'P:25g C:25g F:8g', note: 'é«˜è›‹ç™½ä½è„‚', priority: 4 },
      { name: 'è”¬èœç‚–èœ+å°‘é‡ç²—ç²®', calories: 280, nutrition: 'P:15g C:30g F:6g', note: 'é«˜çº¤ç»´', priority: 3 }
    ]
  };
  
  let options = foods[mealType] || [];
  
  // æ ¹æ®å¹´é¾„å’ŒBMIè¿‡æ»¤
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    options = options.filter(f => f.calories < 400);
  } else if (bmiCategory === 'underweight') {
    options = options.filter(f => f.calories > 300);
  }
  
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    options = options.filter(f => f.note.includes('é«˜è›‹ç™½') || f.note.includes('ä¼˜è´¨è›‹ç™½'));
  } else if (ageGroup === 'è€å¹´(60+)') {
    options = options.filter(f => f.note.includes('æ˜“æ¶ˆåŒ–') || f.note.includes('æ¸…æ·¡'));
  }
  
  if (gender === 'female') {
    options = options.map(f => ({ ...f, priority: f.priority + 1 })); // å¥³æ€§æé«˜ä¼˜å…ˆçº§
  }
  
  return options;
}

function generateSnacks(ageGroup, bmiCategory, calories, gender) {
  const snackCalories = calories;
  const snacks = [
    { name: 'è‹¹æœï¼ˆä¸­ç­‰ï¼‰', calories: 95, nutrition: 'C:25g F:0g', note: 'å¯Œå«çº¤ç»´å’Œç»´ç”Ÿç´ C' },
    { name: 'æ ¸æ¡ƒï¼ˆ3ä¸ªï¼‰', calories: 100, nutrition: 'P:4g F:10g', note: 'Omega-3è„‚è‚ªé…¸' },
    { name: 'é…¸å¥¶ï¼ˆ100gï¼‰', calories: 60, nutrition: 'P:5g C:3g F:3g', note: 'ç›Šç”ŸèŒï¼ŒåŠ©æ¶ˆåŒ–' },
    { name: 'å…¨éº¦é¥¼å¹²ï¼ˆ2ç‰‡ï¼‰', calories: 70, nutrition: 'C:12g F:2g', note: 'ç¼“æ…¢é‡Šæ”¾èƒ½é‡' },
    { name: 'ç…®é¸¡è›‹ï¼ˆ1ä¸ªï¼‰', calories: 70, nutrition: 'P:6g F:5g', note: 'ä¼˜è´¨è›‹ç™½è´¨' }
  ];
  
  let filteredSnacks = snacks.filter(s => s.calories <= snackCalories);
  
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    filteredSnacks = filteredSnacks.filter(s => s.calories < 80);
  } else if (bmiCategory === 'underweight') {
    filteredSnacks = filteredSnacks.filter(s => s.calories > 60);
  }
  
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    filteredSnacks = filteredSnacks.filter(s => s.note.includes('è›‹ç™½è´¨') || s.note.includes('ç»´ç”Ÿç´ '));
  } else if (ageGroup === 'è€å¹´(60+)') {
    filteredSnacks = filteredSnacks.filter(s => s.note.includes('æ˜“æ¶ˆåŒ–'));
  }
  
  if (filteredSnacks.length === 0 && snackCalories > 0) {
    filteredSnacks = snacks.slice(0, 2);
  }
  
  return {
    totalCalories: snackCalories,
    foods: filteredSnacks
  };
}

function getNutritionGoals(ageGroup, bmiCategory, gender) {
  const goals = {
    protein: { min: 0.8, max: 1.2, unit: 'g/kgä½“é‡' },
    carbs: { min: 3, max: 5, unit: 'g/kgä½“é‡' },
    fat: { min: 0.8, max: 1.2, unit: 'g/kgä½“é‡' },
    fiber: { min: 25, max: 35, unit: 'g/å¤©' },
    water: { min: 1500, max: 3000, unit: 'ml/å¤©' }
  };
  
  if (bmiCategory === 'obese' || bmiCategory === 'overweight') {
    goals.protein.max = 1.5; // å¢åŠ è›‹ç™½è´¨
    goals.carbs.max = 3;     // å‡å°‘ç¢³æ°´
    goals.fat.max = 1.0;     // æ§åˆ¶è„‚è‚ª
  } else if (bmiCategory === 'underweight') {
    goals.protein.min = 1.2; // å¢è‚Œ
    goals.carbs.max = 6;     // å¢åŠ ç¢³æ°´
    goals.fat.max = 1.5;     // å¢åŠ å¥åº·è„‚è‚ª
  }
  
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    goals.protein.max = 1.5;  // ç”Ÿé•¿å‘è‚²éœ€è¦
    goals.calcium = { min: 1000, max: 1300, unit: 'mg/å¤©' };
  } else if (ageGroup === 'è€å¹´(60+)') {
    goals.protein.min = 1.0;  // é˜²æ­¢è‚Œè‚‰æµå¤±
    goals.calcium = { min: 1200, max: 1500, unit: 'mg/å¤©' };
  }
  
  if (gender === 'female') {
    goals.iron = { min: 18, max: 20, unit: 'mg/å¤©' };
  } else if (gender === 'male') {
    goals.zinc = { min: 11, max: 15, unit: 'mg/å¤©' };
  }
  
  return goals;
}

function getSpecialRecommendations(ageGroup, bmiCategory, gender) {
  const recommendations = [];
  
  if (bmiCategory === 'obese') {
    recommendations.push({
      icon: 'fas fa-weight',
      title: 'å‡é‡ç›®æ ‡',
      description: 'å»ºè®®æ¯å‘¨å‡é‡0.5-1kgï¼Œå¾ªåºæ¸è¿›',
      priority: 'high',
      tips: ['æ§åˆ¶æ¯æ—¥çƒ­é‡èµ¤å­—500-750å¤§å¡', 'å¢åŠ æœ‰æ°§è¿åŠ¨è‡³æ¯å‘¨300åˆ†é’Ÿ', 'è®°å½•é¥®é£Ÿæ—¥è®°']
    });
  } else if (bmiCategory === 'overweight') {
    recommendations.push({
      icon: 'fas fa-balance-scale',
      title: 'ä½“é‡æ§åˆ¶',
      description: 'ä¿æŒå¥åº·ä½“é‡ï¼Œé˜²æ­¢ç»§ç»­å¢åŠ ',
      priority: 'medium',
      tips: ['æ¯å‘¨ç›‘æµ‹ä½“é‡å˜åŒ–', 'å¢åŠ è”¬èœæ‘„å…¥è‡³æ¯æ—¥500g', 'å‡å°‘ç²¾åˆ¶ç³–']
    });
  } else if (bmiCategory === 'underweight') {
    recommendations.push({
      icon: 'fas fa-utensil-spoon',
      title: 'è¥å…»å¢åŠ ',
      description: 'é€‚å½“å¢åŠ çƒ­é‡å’Œè›‹ç™½è´¨æ‘„å…¥',
      priority: 'high',
      tips: ['å¢åŠ å¥åº·é›¶é£Ÿï¼Œå¦‚åšæœã€é…¸å¥¶', 'å°‘é‡å¤šé¤ï¼Œæ¯æ—¥5-6é¤', 'å¢åŠ ä¼˜è´¨è›‹ç™½è´¨æ‘„å…¥']
    });
  }
  
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    recommendations.push({
      icon: 'fas fa-baby',
      title: 'ç”Ÿé•¿å‘è‚²',
      description: 'å…³é”®æ—¶æœŸï¼Œæ³¨é‡å…¨é¢è¥å…»',
      priority: 'high',
      tips: ['ä¿è¯æ¯æ—¥é’™è´¨1000-1300mg', 'ä¼˜è´¨è›‹ç™½è´¨æ¯æ—¥1.5g/kgä½“é‡', 'å……è¶³ç¡çœ 8-10å°æ—¶']
    });
  } else if (ageGroup === 'è€å¹´(60+)') {
    recommendations.push({
      icon: 'fas fa-bone',
      title: 'éª¨éª¼å¥åº·',
      description: 'é¢„é˜²éª¨è´¨ç–æ¾å’Œè‚Œè‚‰æµå¤±',
      priority: 'high',
      tips: ['è¡¥å……ç»´ç”Ÿç´ D 800-2000IU/å¤©', 'è›‹ç™½è´¨æ¯æ—¥1.0-1.2g/kgä½“é‡', 'é€‚å½“åŠ›é‡è®­ç»ƒ']
    });
  }
  
  if (gender === 'female') {
    recommendations.push({
      icon: 'fas fa-venus',
      title: 'å¥³æ€§å¥åº·',
      description: 'ç‰¹åˆ«å…³æ³¨é“è´¨å’Œé’™è´¨',
      priority: 'medium',
      tips: ['æœˆç»æœŸé¢å¤–è¡¥å……é“è´¨', 'æ¯æ—¥é’™è´¨æ‘„å…¥1000-1200mg', 'æ³¨æ„å¶é…¸æ‘„å…¥ï¼ˆå¤‡å­•ï¼‰']
    });
  }
  
  return recommendations;
}

function getPeerHealthAnalysis(ageGroup, bmiCategory, allUsers) {
  const peerUsers = allUsers.filter(user => {
    const userAgeGroup = getAgeGroup(user.age);
    return userAgeGroup === ageGroup;
  });
  
  if (peerUsers.length === 0) {
    return getDefaultPeerAnalysis(ageGroup, bmiCategory);
  }
  
  // è®¡ç®—ç»Ÿè®¡æ•°æ®
  const stats = calculatePeerStats(peerUsers);
  const commonIssues = analyzeCommonIssues(peerUsers, bmiCategory);
  const recommendations = generatePeerRecommendations(stats, commonIssues, ageGroup, bmiCategory);
  
  return {
    peerCount: peerUsers.length,
    stats: stats,
    commonIssues: commonIssues,
    recommendations: recommendations
  };
}

function calculatePeerStats(peerUsers) {
  const bmis = peerUsers.map(u => parseFloat(u.bmi) || 0).filter(b => b > 0);
  const ages = peerUsers.map(u => parseInt(u.age) || 0).filter(a => a > 0);
  
  if (bmis.length === 0) {
    return {
      avgBMI: 'æš‚æ— æ•°æ®',
      maxBMI: 'æš‚æ— æ•°æ®',
      minBMI: 'æš‚æ— æ•°æ®',
      bmiDistribution: null,
      totalUsers: peerUsers.length
    };
  }
  
  const avgBMI = (bmis.reduce((a, b) => a + b, 0) / bmis.length).toFixed(1);
  const maxBMI = Math.max(...bmis).toFixed(1);
  const minBMI = Math.min(...bmis).toFixed(1);
  
  const bmiDistribution = {
    'underweight': bmis.filter(b => b < 18.5).length,
    'normal': bmis.filter(b => b >= 18.5 && b < 24).length,
    'overweight': bmis.filter(b => b >= 24 && b < 28).length,
    'obese': bmis.filter(b => b >= 28).length
  };
  
  return {
    avgBMI,
    maxBMI,
    minBMI,
    bmiDistribution,
    totalUsers: peerUsers.length
  };
}

function analyzeCommonIssues(peerUsers, currentBMICategory) {
  const issues = [];
  const stats = calculatePeerStats(peerUsers);
  
  if (stats.bmiDistribution) {
    const total = peerUsers.length;
    const overweightCount = stats.bmiDistribution.overweight + stats.bmiDistribution.obese;
    
    if (overweightCount > total * 0.4) {
      issues.push({
        type: 'weight',
        severity: 'high',
        title: 'æ™®éè¶…é‡é—®é¢˜',
        description: `${Math.round((overweightCount / total) * 100)}%çš„åŒé¾„äººå­˜åœ¨è¶…é‡æˆ–è‚¥èƒ–é—®é¢˜`,
        suggestions: ['å¢åŠ æœ‰æ°§è¿åŠ¨', 'æ§åˆ¶ç¢³æ°´åŒ–åˆç‰©æ‘„å…¥', 'å‡å°‘åŠ å·¥é£Ÿå“']
      });
    }
    
    if (stats.avgBMI < 20 && currentBMICategory !== 'underweight') {
      issues.push({
        type: 'underweight',
        severity: 'medium',
        title: 'ä½“é‡åä½ç°è±¡',
        description: 'åŒé¾„äººå¹³å‡BMIåä½ï¼Œéœ€è¦æ³¨æ„è¥å…»æ‘„å…¥',
        suggestions: ['å¢åŠ ä¼˜è´¨è›‹ç™½è´¨', 'å°‘é‡å¤šé¤', 'é€‚å½“å¢åŠ å¥åº·è„‚è‚ª']
      });
    }
  }
  
  return issues;
}

function generatePeerRecommendations(stats, commonIssues, ageGroup, bmiCategory) {
  const recommendations = [];
  
  if (stats.avgBMI && stats.avgBMI > 24) {
    recommendations.push({
      category: 'weight',
      priority: 'high',
      title: 'ä½“é‡ç®¡ç†',
      description: `åŒé¾„äººå¹³å‡BMIä¸º${stats.avgBMI}ï¼Œç•¥é«˜äºå¥åº·èŒƒå›´`,
      details: [
        'æ§åˆ¶æ¯æ—¥çƒ­é‡æ‘„å…¥ï¼Œåˆ›é€ é€‚é‡çƒ­é‡ç¼ºå£',
        'å¢åŠ è†³é£Ÿçº¤ç»´æ‘„å…¥ï¼Œæé«˜é¥±è…¹æ„Ÿ',
        'æ¯å‘¨è‡³å°‘150åˆ†é’Ÿä¸­ç­‰å¼ºåº¦æœ‰æ°§è¿åŠ¨',
        'è®°å½•é¥®é£Ÿæ—¥è®°ï¼Œæé«˜è‡ªæˆ‘ç›‘æ§æ„è¯†'
      ],
      successRate: '70%',
      timeFrame: '3-6ä¸ªæœˆå¯è§æ˜æ˜¾æ•ˆæœ'
    });
  }
  
  commonIssues.forEach(issue => {
    if (issue.severity === 'high') {
      recommendations.push({
        category: issue.type,
        priority: 'high',
        title: issue.title,
        description: issue.description,
        details: issue.suggestions,
        successRate: '85%',
        timeFrame: 'åšæŒ4å‘¨å½¢æˆä¹ æƒ¯'
      });
    }
  });
  
  return recommendations;
}

function getDefaultPeerAnalysis(ageGroup, bmiCategory) {
  return {
    peerCount: 0,
    stats: {
      avgBMI: 'æš‚æ— æ•°æ®',
      totalUsers: 0
    },
    commonIssues: [],
    recommendations: getAgeSpecificRecommendations(ageGroup, bmiCategory)
  };
}

function getAgeSpecificRecommendations(ageGroup, bmiCategory) {
  const recommendations = [];
  
  if (ageGroup === 'é’å°‘å¹´(<18)') {
    recommendations.push({
      category: 'growth',
      priority: 'high',
      title: 'ç”Ÿé•¿å‘è‚²æ”¯æŒ',
      description: 'é’æ˜¥æœŸæ˜¯å…³é”®å‘è‚²æœŸï¼Œéœ€è¦å……è¶³è¥å…»',
      details: [
        'æ¯æ—¥ä¿è¯500mlç‰›å¥¶æˆ–åŒç­‰é’™è´¨',
        'ä¼˜è´¨è›‹ç™½æ‘„å…¥1.2-1.6g/kgä½“é‡',
        'é“è´¨è¡¥å……ï¼Œç‰¹åˆ«æ˜¯é’æ˜¥æœŸå¥³æ€§',
        'ç»´ç”Ÿç´ Dè¡¥å……ï¼Œä¿ƒè¿›é’™å¸æ”¶',
        'å……è¶³ç¡çœ 8-10å°æ—¶/å¤©'
      ],
      successRate: '90%',
      timeFrame: 'æŒç»­æ•´ä¸ªé’æ˜¥æœŸ'
    });
  } else if (ageGroup === 'é’å¹´(18-30)') {
    recommendations.push({
      category: 'habit',
      priority: 'medium',
      title: 'å»ºç«‹å¥åº·ä¹ æƒ¯',
      description: 'é’å¹´æœŸæ˜¯å»ºç«‹ç»ˆèº«å¥åº·ä¹ æƒ¯çš„å…³é”®æœŸ',
      details: [
        'è§„å¾‹ä¸‰é¤ï¼Œé¿å…é•¿æœŸå¤–å–',
        'æ¯å‘¨3-5æ¬¡è¿åŠ¨ï¼Œä¿æŒæ´»åŠ›',
        'æ§åˆ¶é…’ç²¾æ‘„å…¥ï¼Œé¿å…çƒŸé…’',
        'å»ºç«‹è§„å¾‹ä½œæ¯ï¼Œä¿è¯ç¡çœ ',
        'å­¦ä¹ è¥å…»çŸ¥è¯†ï¼Œç§‘å­¦é¥®é£Ÿ'
      ],
      successRate: '80%',
      timeFrame: '21å¤©å½¢æˆä¹ æƒ¯'
    });
  } else if (ageGroup === 'ä¸­å¹´(31-45)') {
    recommendations.push({
      category: 'metabolism',
      priority: 'high',
      title: 'ä»£è°¢ç®¡ç†',
      description: 'æ–°é™ˆä»£è°¢å¼€å§‹ä¸‹é™ï¼Œéœ€è¦è°ƒæ•´é¥®é£Ÿç»“æ„',
      details: [
        'æ§åˆ¶çƒ­é‡æ‘„å…¥ï¼Œé˜²æ­¢ä¸­å¹´å‘ç¦',
        'å¢åŠ è›‹ç™½è´¨æ¯”ä¾‹ï¼Œç»´æŒè‚Œè‚‰é‡',
        'å‡å°‘ç²¾åˆ¶ç¢³æ°´ï¼Œå¢åŠ å…¨è°·ç‰©',
        'å®šæœŸä½“æ£€ï¼Œç›‘æµ‹ä¸‰é«˜æŒ‡æ ‡',
        'å‹åŠ›ç®¡ç†ï¼Œé¿å…æƒ…ç»ªæ€§è¿›é£Ÿ'
      ],
      successRate: '75%',
      timeFrame: '3ä¸ªæœˆè°ƒæ•´æœŸ'
    });
  } else if (ageGroup === 'ä¸­è€å¹´(46-60)') {
    recommendations.push({
      category: 'prevention',
      priority: 'high',
      title: 'æ…¢ç—…é¢„é˜²',
      description: 'é¢„é˜²æ…¢æ€§ç–¾ç—…çš„å…³é”®æ—¶æœŸ',
      details: [
        'ä½ç›ä½è„‚é¥®é£Ÿï¼Œæ§åˆ¶è¡€å‹è¡€è„‚',
        'å¢åŠ è†³é£Ÿçº¤ç»´ï¼Œé¢„é˜²ä¾¿ç§˜',
        'è¡¥å……é’™è´¨å’Œç»´ç”Ÿç´ D',
        'é€‚å½“åŠ›é‡è®­ç»ƒï¼Œé¢„é˜²è‚Œå°‘ç—‡',
        'å®šæœŸä½“æ£€ï¼Œæ—©æœŸå‘ç°é—®é¢˜'
      ],
      successRate: '85%',
      timeFrame: 'é•¿æœŸåšæŒ'
    });
  } else if (ageGroup === 'è€å¹´(60+)') {
    recommendations.push({
      category: 'aging',
      priority: 'high',
      title: 'å¥åº·è€é¾„åŒ–',
      description: 'ç»´æŒåŠŸèƒ½ï¼Œæé«˜ç”Ÿæ´»è´¨é‡',
      details: [
        'ä¼˜è´¨è›‹ç™½æ‘„å…¥ï¼Œé˜²æ­¢è‚Œè‚‰æµå¤±',
        'æ˜“æ¶ˆåŒ–é£Ÿç‰©ï¼Œå°‘é‡å¤šé¤',
        'å……è¶³æ°´åˆ†ï¼Œé¢„é˜²è„±æ°´',
        'é€‚å½“æ´»åŠ¨ï¼Œç»´æŒå…³èŠ‚çµæ´»æ€§',
        'ç¤¾äº¤æ´»åŠ¨ï¼Œå¿ƒç†å¥åº·é‡è¦'
      ],
      successRate: '80%',
      timeFrame: 'æŒç»­æ”¹å–„'
    });
  }
  
  return recommendations;
}

// ================= æœ¬åœ°å­˜å‚¨ =================
function saveToLocalStorage(data) {
  try {
    const stored = JSON.parse(localStorage.getItem('health_data') || '[]');
    stored.push(data);
    localStorage.setItem('health_data', JSON.stringify(stored));
  } catch (error) {
    console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
  }
}

function loadLocalData() {
  try {
    const stored = JSON.parse(localStorage.getItem('health_data') || '[]');
    if (stored.length > 0) {
      allUsersData = stored;
      updateStatistics();
      updateChart();
      updateUserTable();
    }
  } catch (error) {
    console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', error);
  }
}

// ================= ç”¨æˆ·ç®¡ç† =================
function addUserToTable(user) {
  console.log('æ·»åŠ ç”¨æˆ·åˆ°è¡¨æ ¼:', user);
  const tableBody = document.getElementById('userTableBody');
  if (!tableBody) return;
  
  // å¦‚æœæ˜¯ç©ºçš„å ä½ç¬¦ï¼Œå…ˆæ¸…ç©º
  const emptyRow =
